"use strict";angular.module("jackrabbitsgroup.angular-datetimepicker",[]).directive("jrgDatetimepicker",[function(){function convertTimezone(dateMoment,tzFromMinutes,tzToMinutes,params){var ret={date:!1,dateFormatted:!1};(void 0===tzFromMinutes||!tzFromMinutes&&0!==tzFromMinutes)&&(tzFromMinutes=dateMoment.zone()),(void 0===tzToMinutes||!tzToMinutes&&0!==tzToMinutes)&&(tzToMinutes=moment().zone());var tzDiffMinutes=tzToMinutes-tzFromMinutes;dateMoment=tzDiffMinutes>-1?dateMoment.subtract("minutes",tzDiffMinutes):dateMoment.add("minutes",tzDiffMinutes);var dateFormatted=dateMoment.format("YYYY-MM-DD HH:mm:ss"),tzToMinutesAbsVal=tzToMinutes;0>tzToMinutesAbsVal&&(tzToMinutesAbsVal=-1*tzToMinutesAbsVal);var hrOffset=Math.floor(tzToMinutesAbsVal/60).toString();1==hrOffset.length&&(hrOffset="0"+hrOffset);var minutesOffset=(tzToMinutesAbsVal%60).toString();1==minutesOffset.length&&(minutesOffset="0"+minutesOffset);var plusMinus="+";tzToMinutes>=0&&(plusMinus="-");var tzOffsetString=plusMinus+hrOffset+":"+minutesOffset;return dateFormatted+=""+tzOffsetString,ret.date=moment(dateFormatted,"YYYY-MM-DD HH:mm:ssZ"),void 0!==params.format&&(ret.dateFormatted=ret.date.format(params.format)),ret}return{restrict:"A",scope:{ngModel:"=",validate:"&",ngChange:"&?",opts:"=",ngClick:"&?"},replace:!0,template:function(element,attrs){var type="pikaday";"undefined"!=typeof forge&&forge&&void 0!==forge&&(type="forge"),attrs.placeholder||(attrs.placeholder="Choose a date/time");var class1="";attrs.class&&(class1+=attrs.class);var customAttrs="",skipAttrs=["jrgDatetimepicker","ngModel","label","type","placeholder","opts","name","validate","ngChange","ngClick"];angular.forEach(attrs,function(value,key){"$"!==key.charAt(0)&&-1===skipAttrs.indexOf(key)&&(customAttrs+=attrs.$attr[key],attrs[key]&&(customAttrs+="="+attrs[key]),customAttrs+=" ")});var html="<div class='"+class1+"'>";return"pikaday"==type?(html+="<input class='jrg-datetimepicker-input' type='datetime' placeholder='"+attrs.placeholder+"' "+customAttrs+" ",attrs.ngClick&&(html+="ng-click='ngClick()' "),html+="/>"):"forge"==type&&(html+="<input class='jrg-datetimepicker-input' type='datetime-local' placeholder='"+attrs.placeholder+"' "+customAttrs+" ",attrs.ngClick&&(html+="ng-click='ngClick()' "),html+="/>"),html+="</div>",attrs.type=type,html},link:function(scope,element,attrs){function setModelVal(val){if(scope.ngModel=val,"forge"==attrs.type){var dateObj=moment(scope.ngModel,scope.opts.formatModel),inputFormat=dateObj.format(inputFormatString);document.getElementById(attrs.id).value=inputFormat}else{var dateFormat="YYYY-MM-DD",timeFormat="HH:mm:ss",modelFormatted=moment(scope.ngModel,scope.opts.formatModel).format(dateFormat+" "+timeFormat+"Z"),dateOnly=modelFormatted,timeOnly="";modelFormatted.indexOf(" ")>-1&&(dateOnly=modelFormatted.slice(0,modelFormatted.indexOf(" ")),timeOnly=modelFormatted.slice(modelFormatted.indexOf(" ")+1,modelFormatted.length)),picker.setMoment(moment(dateOnly,dateFormat)),picker.setTimeMoment(moment(timeOnly,timeFormat))}}function onSelectDate(date){if(!triggerSkipSelect){var existingVal=scope.ngModel;updateModel(date,{}),void 0!==scope.validate&&void 0!==scope.validate()&&"function"==typeof scope.validate()?scope.validate()(date,{opts:scope.opts},function(valid){if(valid)handleValidOnchange(date,{});else{var blankOut=!0;scope.opts.revertOnInvalid&&existingVal&&(blankOut=!1,setModelVal(existingVal)),blankOut&&(date="",document.getElementById(attrs.id).value="",updateModel(date,{}))}}):handleValidOnchange(date,{}),scope.$$phase||scope.$apply()}}function updateModel(date){scope.ngModel=date,scope.$$phase||scope.$apply()}function handleValidOnchange(date){void 0!==scope.ngChange&&void 0!==scope.ngChange()&&"function"==typeof scope.ngChange()&&scope.ngChange()(date,{opts:scope.opts})}var defaults={opts:{formatModel:"YYYY-MM-DD HH:mm:ssZ",formatDisplay:"YYYY-MM-DD HH:mm:ssZ",revertOnInvalid:!1}};scope.opts=angular.extend(defaults.opts,scope.opts),void 0!==scope.opts.id?attrs.id=scope.opts.id:void 0===attrs.id&&(attrs.id="jrgDatetimepicker"+Math.random().toString(36).substring(7)),element.find("input").attr("id",attrs.id);var inputFormatString,triggerSkipSelect=!0;if("forge"==attrs.type)inputFormatString="YYYY-MM-DDTHH:mm:ss",forge.ui.enhanceInput("#"+attrs.id),scope.ngModel&&setModelVal(scope.ngModel),element.find("input").bind("blur",function(){var dateMoment,date=document.getElementById(attrs.id).value,tzFromMinutes=!1;"object"==typeof date?dateMoment=moment(date):"string"==typeof date&&(dateMoment=moment(date,"YYYY-MM-DD HH:mm"),date.indexOf("Z")>-1&&(tzFromMinutes=0));var format1="YYYY-MM-DD HH:mm:ssZ",dtInfo=convertTimezone(dateMoment,tzFromMinutes,!1,{format:format1}),formattedModelVal=moment(dtInfo.dateFormatted,format1).format(scope.opts.formatModel),inputFormat=dtInfo.date.format(inputFormatString);document.getElementById(attrs.id).value=inputFormat,onSelectDate(formattedModelVal)});else{var defaultPikadayOpts={field:document.getElementById(attrs.id),onSelect:function(){var date=this.getMoment().format(scope.opts.formatModel);onSelectDate(date)},minDate:new Date("2000-01-01"),maxDate:new Date("2020-12-31"),yearRange:[2e3,2020]};void 0===scope.opts.pikaday&&(scope.opts.pikaday={}),scope.opts.pikaday.format=scope.opts.formatDisplay;var pikadayOpts=angular.extend(defaultPikadayOpts,scope.opts.pikaday),picker=new Pikaday(pikadayOpts);scope.ngModel&&setModelVal(scope.ngModel)}triggerSkipSelect=!1,scope.$on("jrgDatetimepickerUpdateVal",function(evt,params){void 0!==scope.opts.id&&void 0!==params.instId&&scope.opts.id==params.instId&&setModelVal(params.val)})}}}]);